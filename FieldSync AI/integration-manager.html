<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FieldSync AI - Integration Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .content {
            padding: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .integrations-section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8rem;
            color: #1f2937;
            font-weight: 700;
        }

        .integrations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .integration-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .integration-card:hover {
            border-color: #4f46e5;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.1);
        }

        .integration-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .integration-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .integration-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .integration-details h3 {
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .integration-details p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-inactive {
            background: #fef2f2;
            color: #dc2626;
        }

        .status-syncing {
            background: #fef3c7;
            color: #d97706;
        }

        .integration-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stat-item-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-item-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .integration-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #1f2937;
            font-weight: 700;
        }

        .close {
            color: #9ca3af;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #374151;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #dc2626;
            color: #dc2626;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #2563eb;
            color: #1d4ed8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #374151;
        }

        .empty-state p {
            font-size: 1rem;
            margin-bottom: 25px;
        }

        .refresh-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #16a34a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó Integration Manager</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshAllIntegrations()">
                    üîÑ Refresh All
                </button>
                <button class="btn btn-primary" onclick="openAddIntegrationModal()">
                    ‚ûï Add Integration
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Statistics Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-integrations">0</div>
                    <div class="stat-label">Total Integrations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-integrations">0</div>
                    <div class="stat-label">Active Connections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="syncing-integrations">0</div>
                    <div class="stat-label">Currently Syncing</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="last-sync-time">--</div>
                    <div class="stat-label">Last Sync</div>
                </div>
            </div>

            <!-- Integrations Section -->
            <div class="integrations-section">
                <div class="section-header">
                    <h2 class="section-title">Your Integrations</h2>
                    <button class="btn btn-success" onclick="syncAllData()">
                        ‚ö° Sync All Data
                    </button>
                </div>

                <div id="integrations-container">
                    <div class="integrations-grid" id="integrations-grid">
                        <!-- Integration cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Integration Modal -->
    <div id="addIntegrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Integration</h2>
                <span class="close" onclick="closeAddIntegrationModal()">&times;</span>
            </div>
            <form id="addIntegrationForm">
                <div class="form-group">
                    <label class="form-label">Integration Type</label>
                    <select class="form-select" id="integrationType" onchange="updateIntegrationForm()">
                        <option value="">Select Integration Type</option>
                        <option value="google-sheets">Google Sheets</option>
                        <option value="quickbooks">QuickBooks</option>
                        <option value="postgresql">PostgreSQL</option>
                        <option value="mysql">MySQL</option>
                        <option value="shopify">Shopify</option>
                        <option value="stripe">Stripe</option>
                        <option value="csv">CSV Upload</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Integration Name</label>
                    <input type="text" class="form-input" id="integrationName" placeholder="Enter a name for this integration">
                </div>
                <div id="dynamicFields">
                    <!-- Dynamic fields will be populated based on integration type -->
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Create Integration
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Integration Details Modal -->
    <div id="integrationDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="detailsModalTitle">Integration Details</h2>
                <span class="close" onclick="closeIntegrationDetailsModal()">&times;</span>
            </div>
            <div id="integrationDetailsContent">
                <!-- Integration details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let integrations = [];
        let currentIntegration = null;

        // API Base URL
        const API_BASE = 'http://localhost:3000/api';

        // Integration type configurations
        const integrationConfigs = {
            'google-sheets': {
                name: 'Google Sheets',
                icon: 'üìä',
                color: '#34a853',
                fields: [
                    { name: 'spreadsheetId', label: 'Spreadsheet ID', type: 'text', required: true },
                    { name: 'worksheetName', label: 'Worksheet Name', type: 'text', required: false }
                ]
            },
            'quickbooks': {
                name: 'QuickBooks',
                icon: 'üíº',
                color: '#0077c5',
                fields: [
                    { name: 'companyId', label: 'Company ID', type: 'text', required: true }
                ]
            },
            'postgresql': {
                name: 'PostgreSQL',
                icon: 'üêò',
                color: '#336791',
                fields: [
                    { name: 'host', label: 'Host', type: 'text', required: true },
                    { name: 'port', label: 'Port', type: 'number', required: true, default: 5432 },
                    { name: 'database', label: 'Database', type: 'text', required: true },
                    { name: 'username', label: 'Username', type: 'text', required: true },
                    { name: 'password', label: 'Password', type: 'password', required: true },
                    { name: 'ssl', label: 'Use SSL', type: 'checkbox', required: false }
                ]
            },
            'mysql': {
                name: 'MySQL',
                icon: 'üê¨',
                color: '#4479a1',
                fields: [
                    { name: 'host', label: 'Host', type: 'text', required: true },
                    { name: 'port', label: 'Port', type: 'number', required: true, default: 3306 },
                    { name: 'database', label: 'Database', type: 'text', required: true },
                    { name: 'username', label: 'Username', type: 'text', required: true },
                    { name: 'password', label: 'Password', type: 'password', required: true },
                    { name: 'ssl', label: 'Use SSL', type: 'checkbox', required: false }
                ]
            },
            'shopify': {
                name: 'Shopify',
                icon: 'üõçÔ∏è',
                color: '#96bf48',
                fields: [
                    { name: 'shopName', label: 'Shop Name', type: 'text', required: true },
                    { name: 'accessToken', label: 'Access Token', type: 'password', required: true }
                ]
            },
            'stripe': {
                name: 'Stripe',
                icon: 'üí≥',
                color: '#635bff',
                fields: [
                    { name: 'apiKey', label: 'API Key', type: 'password', required: true }
                ]
            },
            'csv': {
                name: 'CSV Upload',
                icon: 'üìÑ',
                color: '#f59e0b',
                fields: [
                    { name: 'file', label: 'CSV File', type: 'file', required: true, accept: '.csv' }
                ]
            }
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadIntegrations();
            updateStats();
        });

        // Load integrations from API
        async function loadIntegrations() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE}/integrations/data-sources`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    integrations = data.dataSources || [];
                    renderIntegrations();
                    updateStats();
                } else {
                    showError('Failed to load integrations');
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
                showError('Failed to connect to server');
            } finally {
                hideLoading();
            }
        }

        // Render integrations grid
        function renderIntegrations() {
            const container = document.getElementById('integrations-grid');
            
            if (integrations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üîó</div>
                        <h3>No Integrations Yet</h3>
                        <p>Connect your first data source to get started with FieldSync AI</p>
                        <button class="btn btn-primary" onclick="openAddIntegrationModal()">
                            Add Your First Integration
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = integrations.map(integration => {
                const config = integrationConfigs[integration.type] || {
                    name: integration.type,
                    icon: 'üîó',
                    color: '#6b7280'
                };

                const status = getIntegrationStatus(integration);
                const lastSync = integration.metadata?.lastSync ? 
                    new Date(integration.metadata.lastSync).toLocaleString() : 'Never';

                return `
                    <div class="integration-card">
                        ${status === 'syncing' ? '<div class="refresh-indicator"></div>' : ''}
                        <div class="integration-header">
                            <div class="integration-info">
                                <div class="integration-icon" style="background: ${config.color}">
                                    ${config.icon}
                                </div>
                                <div class="integration-details">
                                    <h3>${integration.name}</h3>
                                    <p>${config.name}</p>
                                </div>
                            </div>
                            <span class="status-badge status-${status}">${status}</span>
                        </div>
                        
                        <div class="integration-stats">
                            <div class="stat-item">
                                <div class="stat-item-value">${integration.metadata?.recordCount || 0}</div>
                                <div class="stat-item-label">Records</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-item-value">${integration.metadata?.tableCount || 1}</div>
                                <div class="stat-item-label">Tables</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-item-value">${getDataFreshness(integration)}</div>
                                <div class="stat-item-label">Freshness</div>
                            </div>
                        </div>
                        
                        <div class="integration-actions">
                            <button class="btn btn-primary btn-sm" onclick="testConnection('${integration.id}')">
                                üîç Test
                            </button>
                            <button class="btn btn-success btn-sm" onclick="syncIntegration('${integration.id}')">
                                üîÑ Sync
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="viewIntegrationDetails('${integration.id}')">
                                üìä Details
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteIntegration('${integration.id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get integration status
        function getIntegrationStatus(integration) {
            if (integration.status === 'syncing') return 'syncing';
            if (integration.status === 'active') return 'active';
            return 'inactive';
        }

        // Get data freshness indicator
        function getDataFreshness(integration) {
            if (!integration.metadata?.lastSync) return 'Never';
            
            const lastSync = new Date(integration.metadata.lastSync);
            const now = new Date();
            const diffHours = Math.floor((now - lastSync) / (1000 * 60 * 60));
            
            if (diffHours < 1) return 'Fresh';
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${Math.floor(diffHours / 24)}d ago`;
        }

        // Update statistics
        function updateStats() {
            const total = integrations.length;
            const active = integrations.filter(i => i.status === 'active').length;
            const syncing = integrations.filter(i => i.status === 'syncing').length;
            
            const lastSyncTimes = integrations
                .map(i => i.metadata?.lastSync)
                .filter(Boolean)
                .map(t => new Date(t))
                .sort((a, b) => b - a);
            
            const lastSync = lastSyncTimes.length > 0 ? 
                lastSyncTimes[0].toLocaleString() : '--';

            document.getElementById('total-integrations').textContent = total;
            document.getElementById('active-integrations').textContent = active;
            document.getElementById('syncing-integrations').textContent = syncing;
            document.getElementById('last-sync-time').textContent = lastSync;
        }

        // Open add integration modal
        function openAddIntegrationModal() {
            document.getElementById('addIntegrationModal').style.display = 'block';
        }

        // Close add integration modal
        function closeAddIntegrationModal() {
            document.getElementById('addIntegrationModal').style.display = 'none';
            document.getElementById('addIntegrationForm').reset();
            document.getElementById('dynamicFields').innerHTML = '';
        }

        // Update integration form based on type
        function updateIntegrationForm() {
            const type = document.getElementById('integrationType').value;
            const dynamicFields = document.getElementById('dynamicFields');
            
            if (!type || !integrationConfigs[type]) {
                dynamicFields.innerHTML = '';
                return;
            }

            const config = integrationConfigs[type];
            dynamicFields.innerHTML = config.fields.map(field => {
                let input = '';
                switch (field.type) {
                    case 'text':
                    case 'password':
                    case 'number':
                        input = `<input type="${field.type}" class="form-input" id="${field.name}" 
                                ${field.required ? 'required' : ''} 
                                ${field.default ? `value="${field.default}"` : ''}
                                placeholder="Enter ${field.label.toLowerCase()}">`;
                        break;
                    case 'checkbox':
                        input = `<input type="checkbox" id="${field.name}" style="margin-right: 8px;">
                                <label for="${field.name}">${field.label}</label>`;
                        break;
                    case 'file':
                        input = `<input type="file" class="form-input" id="${field.name}" 
                                ${field.required ? 'required' : ''}
                                ${field.accept ? `accept="${field.accept}"` : ''}>`;
                        break;
                }
                
                return `
                    <div class="form-group">
                        ${field.type !== 'checkbox' ? `<label class="form-label">${field.label}</label>` : ''}
                        ${input}
                    </div>
                `;
            }).join('');
        }

        // Handle add integration form submission
        document.getElementById('addIntegrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('integrationType').value;
            const name = document.getElementById('integrationName').value;
            
            if (!type || !name) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                showLoading();
                
                // Collect form data based on integration type
                const formData = { name };
                const config = integrationConfigs[type];
                
                if (config) {
                    config.fields.forEach(field => {
                        const element = document.getElementById(field.name);
                        if (element) {
                            if (field.type === 'checkbox') {
                                formData[field.name] = element.checked;
                            } else if (field.type === 'file') {
                                formData[field.name] = element.files[0];
                            } else {
                                formData[field.name] = element.value;
                            }
                        }
                    });
                }

                // Create integration via API
                const response = await fetch(`${API_BASE}/integrations/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showAlert('Integration created successfully!', 'success');
                    closeAddIntegrationModal();
                    loadIntegrations();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Failed to create integration', 'error');
                }
            } catch (error) {
                console.error('Error creating integration:', error);
                showAlert('Failed to create integration', 'error');
            } finally {
                hideLoading();
            }
        });

        // Test connection
        async function testConnection(integrationId) {
            const integration = integrations.find(i => i.id === integrationId);
            if (!integration) return;

            try {
                showAlert('Testing connection...', 'info');
                
                const response = await fetch(`${API_BASE}/integrations/${integration.type}/test-connection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ dataSourceId: integrationId })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showAlert('Connection test successful!', 'success');
                } else {
                    showAlert(result.message || 'Connection test failed', 'error');
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                showAlert('Connection test failed', 'error');
            }
        }

        // Sync integration
        async function syncIntegration(integrationId) {
            const integration = integrations.find(i => i.id === integrationId);
            if (!integration) return;

            try {
                // Update UI to show syncing status
                integration.status = 'syncing';
                renderIntegrations();
                updateStats();
                
                showAlert('Starting data synchronization...', 'info');
                
                const response = await fetch(`${API_BASE}/integrations/data-sources/${integrationId}/sync`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showAlert('Data synchronization completed!', 'success');
                    // Reload integrations to get updated status
                    setTimeout(() => loadIntegrations(), 1000);
                } else {
                    showAlert(result.message || 'Synchronization failed', 'error');
                    integration.status = 'active'; // Reset status
                    renderIntegrations();
                    updateStats();
                }
            } catch (error) {
                console.error('Error syncing integration:', error);
                showAlert('Synchronization failed', 'error');
                integration.status = 'active'; // Reset status
                renderIntegrations();
                updateStats();
            }
        }

        // Sync all data
        async function syncAllData() {
            const activeIntegrations = integrations.filter(i => i.status === 'active');
            
            if (activeIntegrations.length === 0) {
                showAlert('No active integrations to sync', 'info');
                return;
            }

            showAlert(`Starting synchronization for ${activeIntegrations.length} integrations...`, 'info');
            
            // Sync all integrations in parallel
            const syncPromises = activeIntegrations.map(integration => 
                syncIntegration(integration.id)
            );
            
            try {
                await Promise.all(syncPromises);
                showAlert('All integrations synchronized successfully!', 'success');
            } catch (error) {
                showAlert('Some synchronizations failed. Check individual integration status.', 'error');
            }
        }

        // Refresh all integrations
        async function refreshAllIntegrations() {
            showAlert('Refreshing integrations...', 'info');
            await loadIntegrations();
            showAlert('Integrations refreshed!', 'success');
        }

        // View integration details
        function viewIntegrationDetails(integrationId) {
            const integration = integrations.find(i => i.id === integrationId);
            if (!integration) return;

            currentIntegration = integration;
            const config = integrationConfigs[integration.type] || { name: integration.type, icon: 'üîó' };
            
            document.getElementById('detailsModalTitle').textContent = `${config.icon} ${integration.name}`;
            
            const content = `
                <div class="alert alert-info">
                    <strong>Integration Type:</strong> ${config.name}<br>
                    <strong>Status:</strong> ${getIntegrationStatus(integration)}<br>
                    <strong>Created:</strong> ${new Date(integration.createdAt).toLocaleString()}<br>
                    <strong>Last Updated:</strong> ${new Date(integration.updatedAt).toLocaleString()}
                </div>
                
                <h3>Metadata</h3>
                <pre style="background: #f8fafc; padding: 15px; border-radius: 8px; overflow-x: auto;">
${JSON.stringify(integration.metadata || {}, null, 2)}
                </pre>
                
                <h3>Available Data Types</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                    ${(integration.metadata?.availableDataTypes || []).map(type => 
                        `<span class="status-badge status-active">${type}</span>`
                    ).join('')}
                </div>
                
                <div style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="detectSchema('${integration.id}')">
                        üîç Detect Schema
                    </button>
                    <button class="btn btn-success" onclick="syncIntegration('${integration.id}'); closeIntegrationDetailsModal();">
                        üîÑ Sync Data
                    </button>
                </div>
            `;
            
            document.getElementById('integrationDetailsContent').innerHTML = content;
            document.getElementById('integrationDetailsModal').style.display = 'block';
        }

        // Close integration details modal
        function closeIntegrationDetailsModal() {
            document.getElementById('integrationDetailsModal').style.display = 'none';
            currentIntegration = null;
        }

        // Detect schema
        async function detectSchema(integrationId) {
            const integration = integrations.find(i => i.id === integrationId);
            if (!integration) return;

            try {
                showAlert('Detecting schema...', 'info');
                
                const response = await fetch(`${API_BASE}/integrations/${integration.type}/detect-schema`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ 
                        dataSourceId: integrationId,
                        dataType: 'all' 
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showAlert('Schema detection completed!', 'success');
                    
                    // Update the details modal with schema information
                    const schemaHtml = `
                        <h4>Detected Schema</h4>
                        <pre style="background: #f8fafc; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 300px;">
${JSON.stringify(result.data, null, 2)}
                        </pre>
                    `;
                    
                    document.getElementById('integrationDetailsContent').innerHTML += schemaHtml;
                } else {
                    showAlert(result.message || 'Schema detection failed', 'error');
                }
            } catch (error) {
                console.error('Error detecting schema:', error);
                showAlert('Schema detection failed', 'error');
            }
        }

        // Delete integration
        async function deleteIntegration(integrationId) {
            const integration = integrations.find(i => i.id === integrationId);
            if (!integration) return;

            if (!confirm(`Are you sure you want to delete the integration "${integration.name}"? This action cannot be undone.`)) {
                return;
            }

            try {
                showAlert('Deleting integration...', 'info');
                
                const response = await fetch(`${API_BASE}/integrations/data-sources/${integrationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    showAlert('Integration deleted successfully!', 'success');
                    loadIntegrations();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Failed to delete integration', 'error');
                }
            } catch (error) {
                console.error('Error deleting integration:', error);
                showAlert('Failed to delete integration', 'error');
            }
        }

        // Utility functions
        function getAuthToken() {
            // In a real application, this would retrieve the JWT token from localStorage or cookies
            return 'dummy-token-for-demo';
        }

        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.querySelector('.content').insertBefore(alert, document.querySelector('.stats-grid'));
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function showLoading() {
            // Add loading indicator to the page
            const loading = document.createElement('div');
            loading.id = 'global-loading';
            loading.innerHTML = '<div class="loading"></div>';
            loading.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1001;';
            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('global-loading');
            if (loading) {
                loading.remove();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addIntegrationModal');
            const detailsModal = document.getElementById('integrationDetailsModal');
            
            if (event.target === addModal) {
                closeAddIntegrationModal();
            }
            if (event.target === detailsModal) {
                closeIntegrationDetailsModal();
            }
        }
    </script>
</body>
</html>