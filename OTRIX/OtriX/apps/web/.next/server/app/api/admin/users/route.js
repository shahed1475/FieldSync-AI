"use strict";(()=>{var e={};e.id=628,e.ids=[628],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},47981:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>v,patchFetch:()=>R,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var a={};s.r(a),s.d(a,{GET:()=>g,POST:()=>x});var t=s(63036),i=s(5736),n=s(15262),o=s(60942),l=s(50311),u=s(79763),d=s(96524),m=s(33772);let p=u.Ry({page:u.oQ.number().int().min(1).default(1),pageSize:u.oQ.number().int().min(1).max(100).default(20),search:u.Z_().optional(),role:u.Km(["user","admin","superadmin"]).optional(),verified:u.oQ.boolean().optional()}),c=u.Ry({email:u.Z_().email("Invalid email address"),name:u.Z_().min(1,"Name is required").max(100),password:u.Z_().min(8,"Password must be at least 8 characters"),role:u.Km(["user","admin","superadmin"]).default("user")});async function g(e){let r=await (0,m.l)();if(r instanceof o.NextResponse)return r;try{let{searchParams:r}=new URL(e.url),s=Object.fromEntries(r.entries()),a=p.parse(s),t={};a.role&&(t.role=a.role),void 0!==a.verified&&(t.emailVerified=a.verified?{not:null}:null),a.search&&(t.OR=[{email:{contains:a.search,mode:"insensitive"}},{name:{contains:a.search,mode:"insensitive"}}]);let i=(a.page-1)*a.pageSize,[n,l]=await Promise.all([d._.user.findMany({where:t,select:{id:!0,email:!0,name:!0,role:!0,emailVerified:!0,createdAt:!0,updatedAt:!0,lastLoginAt:!0,_count:{select:{projects:!0}}},orderBy:{createdAt:"desc"},skip:i,take:a.pageSize}),d._.user.count({where:t})]),u=Math.ceil(l/a.pageSize);return o.NextResponse.json({data:n,pagination:{total:l,page:a.page,pageSize:a.pageSize,totalPages:u,hasMore:a.page<u}})}catch(e){if(console.error("[Users API GET Error]:",e),"ZodError"===e.name)return o.NextResponse.json({error:"Invalid query parameters",details:e.errors},{status:422});return o.NextResponse.json({error:"Failed to fetch users",details:e.message},{status:500})}}async function x(e){let r=await (0,m.l)();if(r instanceof o.NextResponse)return r;try{let r=await e.json(),s=c.parse(r);if(await d._.user.findUnique({where:{email:s.email}}))return o.NextResponse.json({error:"Email already exists",message:"A user with this email address already exists"},{status:409});let a=await (0,l.vp)(s.password,10),t=await d._.user.create({data:{email:s.email,name:s.name,password:a,role:s.role,emailVerified:null},select:{id:!0,email:!0,name:!0,role:!0,emailVerified:!0,createdAt:!0,updatedAt:!0}}),i=await (0,m.e)();return i&&await d._.auditLog.create({data:{userId:i.id,action:"user.created",entity:"user",entityId:t.id,metadata:JSON.stringify({email:t.email,role:t.role}),ipAddress:e.headers.get("x-forwarded-for")||e.ip||"unknown",userAgent:e.headers.get("user-agent")||void 0}}).catch(e=>console.error("[Audit Log Error]:",e)),o.NextResponse.json(t,{status:201})}catch(e){if(console.error("[Users API POST Error]:",e),"ZodError"===e.name)return o.NextResponse.json({error:"Invalid input data",details:e.errors},{status:422});if("P2002"===e.code)return o.NextResponse.json({error:"Email already exists",message:"A user with this email address already exists"},{status:409});return o.NextResponse.json({error:"Failed to create user",details:e.message},{status:500})}}let f=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"C:\\Users\\shahe\\OneDrive\\Desktop\\OTRIX\\OtriX\\apps\\web\\src\\app\\api\\admin\\users\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:y}=f,v="/api/admin/users/route";function R(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},28753:(e,r,s)=>{s.r(r),s.d(r,{GET:()=>m,POST:()=>m,authOptions:()=>d});var a=s(59224),t=s.n(a),i=s(18452),n=s(53524);let o=require("bcrypt");var l=s.n(o);let u=new n.PrismaClient,d={providers:[(0,i.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return console.log("❌ Missing credentials"),null;try{let r=await u.user.findUnique({where:{email:e.email}});if(!r||!r.password)return console.log("❌ User not found:",e.email),null;if(!await l().compare(e.password,r.password))return console.log("❌ Invalid password for:",e.email),null;return console.log("✅ Login successful:",r.email,"Role:",r.role),await u.user.update({where:{id:r.id},data:{lastLoginAt:new Date}}),{id:r.id,email:r.email,name:r.name,role:r.role}}catch(e){return console.error("❌ Authorization error:",e),null}}})],session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login",error:"/login"},callbacks:{jwt:async({token:e,user:r,trigger:s})=>(r&&(e.userId=r.id,e.email=r.email,e.name=r.name,e.role=r.role,console.log("\uD83D\uDD11 JWT token created for user:",r.email,"with role:",r.role)),e),session:async({session:e,token:r})=>(e.user&&r&&(e.user.id=r.userId||r.sub,e.user.email=r.email,e.user.name=r.name,e.user.role=r.role,console.log("\uD83D\uDCDD Session created for user:",r.email,"with role:",r.role)),e),redirect:async({url:e,baseUrl:r})=>(console.log("\uD83D\uDD00 Redirect callback triggered - url:",e,"baseUrl:",r),e.startsWith("/"))?(console.log("✅ Redirecting to relative URL:",`${r}${e}`),`${r}${e}`):new URL(e).origin===r?(console.log("✅ Redirecting to same origin:",e),e):(console.log("✅ Redirecting to default /admin"),`${r}/admin`)},secret:process.env.NEXTAUTH_SECRET,debug:!1},m=t()(d)},33772:(e,r,s)=>{s.d(r,{e:()=>l,l:()=>o});var a=s(60942),t=s(59224),i=s(28753),n=s(96524);async function o(){try{let e=await (0,t.getServerSession)(i.authOptions);if(!e||!e.user?.email)return a.NextResponse.json({error:"Unauthorized",message:"Please sign in"},{status:401});let r=await n._.user.findUnique({where:{email:e.user.email},select:{id:!0,email:!0,role:!0,name:!0}});if(!r)return a.NextResponse.json({error:"Unauthorized",message:"User not found"},{status:401});if("admin"!==r.role&&"superadmin"!==r.role)return a.NextResponse.json({error:"Forbidden",message:"Admin access required"},{status:403});return{user:r}}catch(e){return console.error("[Admin Guard Error]:",e),a.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function l(){let e=await o();return e instanceof a.NextResponse?null:e.user}},96524:(e,r,s)=>{s.d(r,{_:()=>t});var a=s(53524);let t=global.prisma||new a.PrismaClient}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),a=r.X(0,[193,631,942,70],()=>s(47981));module.exports=a})();